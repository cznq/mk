<template>
	<fed-popup v-model="visible" position="bottom" class="fed-roller">
		<div class="fed-roller" :class="rollerClasses"> 
			<div class="fed-roller-body" :class="{'fed-roller-body-top':tops}">
				<roller-topview :title="title" :okTxt="okTxt" :cancelTxt="cancelTxt" @callback="btnClick"></roller-topview>
				<div class="fed-roller-content clearfix">
					<table :class="{'fed-roller-larger':larger}" >
						<tbody>
							<tr>
								<roller-list 
									v-for="(item, index) in listItems" 
									:key="item.name" 
									:item="item" 
									:larger="larger"
									:lhi="lhi"
									@selectChange="selectChange"
									 ></roller-list>
							</tr>
						</tbody>
					</table>
					<p :style="{height:lhi+'px',marginTop:(-lhi / 2) + 'px'}" ></p>
				</div>
			</div>
		</div>
	</fed-popup>
</template>
<script>
const empty = () => { }
import popup from './components/popup'
import rollerTop from './components/topView'
import rollerList from './components/listView'
export default {
	name: 'Roller',
	props: {
		classes: {
			type: String,
			default: ''
		},
		btnPosition: {
			type: String,
			default: ''
		},
		okTxt: {
			type: String,
			default: '确定'
		},
		cancelTxt: {
			type: String,
			default: '取消'
		},
		title: {
			type: String,
			default: '选择'
		},
		listData:{
			type:Array
		},
		lhi: {
			type: Number,
			default: 35
		},
		larger: {
			type: Boolean,
			default: true
		},
		select:{
			type:Function
		},
		cancel:{
			type:Function
		}
	},
	components: {
		'fed-popup': popup,
		'roller-topview': rollerTop,
		'roller-list':rollerList
	},
	data() {
		
		return {
			selectItem: this.setSelectItems(),
			listItems: this.listData,
			rollerClasses: this.classes,  //容器自定义类名
			tops: this.btnPosition === 'top' ? true : false, // 按钮的位置在上面还是下面
			visible: false,
			// okTxt:this.okTxt
		}
	},
	beforeCreate() {
	},
	created (){
	},
	destroyed() {
	},
	methods: {
		selectChange (name, Items,selectedIndex){
			this.selectItem[name] = Items
			this.$emit('change',[name,Items,selectedIndex])
		},
		open() {
			this.visible = true;
		},
		btnClick(val) {
			this.$emit( val ? 'select' : 'cancel',{...this.selectItem})

			this.visible = false;
		},
		setSelectItems (){
			let selectItem = {} || this.selectItem,
				listItems = this.listItems || this.listData;
			
			listItems.forEach(function(element) {
				let chooseed;
				for(let i = 0; i < element.data.length;i++){
					chooseed = element.data[i][0] == element.selected || element.data[i][1] == element.selected ? element.data[i] : false;
					if(chooseed){
						selectItem[element.name] = chooseed;
						element.indexs = i;
						break;
					}
				}
				if(!chooseed){
					element.indexs = 0;
				}
				selectItem[element.name] = selectItem[element.name] || element.data[0]
			});
			return  selectItem;
		},
		listDataUpdateCheckSelect (){
			let selectItem = {} || this.selectItem,
				listItems = this.listItems || this.listData;
			
			listItems.forEach(function(element) {
				let selected = selectItem[element.name] ? selectItem[element.name][0] : element.selected,
					isIn = false;
				for(let i = 0; i < element.data.length;i++){
					let chooseed = element.data[i][0] == selected || element.data[i][1] == selected ? element.data[i] : false;
					if(chooseed){
						isIn = true;
						selectItem[element.name] = chooseed;
						element.indexs = i;
						break;
					}
				}
				if(!isIn){
					selected = element.data[i][element.data[i].length - 1]
					element.selected = selected[0];
					element.indexs = element.data[i].length - 1;
				}
				selectItem[element.name] = selected
			});
			 this.selectItem = selectItem
		}
	},
	watch: {
		listData(){
			this.listItems = this.listData;
			this.listDataUpdateCheckSelect()
		}
	}
}
</script>