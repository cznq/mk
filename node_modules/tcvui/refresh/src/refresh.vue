<template>
 
  <div v-bind:style="{transform:'translateY('+distanceY+'px)'}" v-bind:class="[bAnimation?'refreshview':'']">
    <div :class="[this.spin]">
     <div>
       <i v-bind:class="[status==0?'down':status==1?'down':status==2?'up':status=='3'?'refresh':'down']"></i>
       <span>{{textview}}</span>
     </div>
  </div>
    <div>
   <slot></slot>
    </div>
  </div>

</template>

<script>
var view = document.body,
    dom = document.body;
var index=1;
export default {
 name: 'TcRefresh',
 props:{
   initScrollTop:{
      default: 0,
      type:Number
   },
   damping:{
      default: 0.2,
      type:Number
   },
   didsomethingY:{
     default: 40,
      type:Number
   },
   didSomeAction:{
     default:()=>{},
      type:Function
   },
   bottomdistance:{
   default:0,
      type:Number
   },
   onPulling:{
      default:()=>{},
      type:Function
   },
   downText:{
      default:'下拉刷新',
      type:String
   },
   upText:{
    default:'松开刷新',
      type:String
   },
   loadingText:{
      default:'正在刷新',
      type:String
   },
   tobuttomActionEnd:{
      default:()=>{},
      type:Function
   },
   endRefresh:{
      default:false,
      type:Boolean
   },
   endRefreshAction:{
      default:()=>{},
      type:Function
   },
   spin:{
     default:'drop-refresh-sign',
      type:String
   },
   touchDom:{
     default:'',
     type:String
   },
   onTouchStart:{
    default:()=>{console.log(1232132131231)},
     type:Function
   },
   onPullStatusChange:{
     default:()=>{},
     type:Function
   }

 },

 beforeMount(){
 this.textview = this.downText;
   
 },
 mounted (){
   const {initScrollTop, touchDom} = this;
   if(!!touchDom){
     dom = document.getElementById(this.dom)?document.getElementById(this.dom):document.body;
   }
   dom.scrollTop = this.initScrollTop;
   this.lastScrollTop = this.initScrollTop; //保存先前的位置

     dom.addEventListener('touchstart', this.EventHandlers(this.v_onTouchStart,this.onTouchStart));
     dom.addEventListener('touchmove', this.EventHandlers(this.v_onTouchMove,this.onTouchMove),{ passive: false });
     dom.addEventListener('touchend', this.EventHandlers(this.v_onTouchEnd,this.onTouchEnd));
     window.addEventListener('scroll', this.v_onScrollaction);

 },
 bedoreUpdate (){
 },
 updated(){
 },
 activated(){
 },
 deactivated(){
 },
 destroyed (){
    dom.removeEventListener('touchstart', this.EventHandlers(this.v_onTouchStart,this.onTouchStart));
      dom.removeEventListener('touchmove', this.EventHandlers(this.v_onTouchMove,this.onTouchMove),{ passive: false });
      dom.removeEventListener('touchend', this.EventHandlers(this.v_onTouchEnd,this.onTouchEnd));

       window.removeEventListener('scroll', this.v_onScrollaction);
 },
 data () {

    return {
      distanceY:0,
      lastScrollTop : undefined,
      btouching : false,
      startY : 0,
      status : 0,
      textview : '',
      bAnimation : false,
      bendAction : true,

    }
  },
  watch:{
  },
  computed: {    
  },
  methods: {
    EventHandlers(internal, external){
       return external
        ? e => { internal(e);  external(e); }
        : internal;

    },
    v_onTouchStart (e){
      this.bAnimation = false;
      this.btouching = true;
      this.startY = e.touches ? e.touches[0].pageY : e.pageY;

    },
    v_onTouchMove (e){
       if(!this.btouching) return;
       let currentY = e.touches ? e.touches[0].pageY : e.pageY;
       if(!!this.status) {
         let pullYdistance = (currentY - this.startY) * this.damping;
             if(pullYdistance >=0 ){
                    this.distanceY = pullYdistance;
             
                     if(this.status != 3){
                   
                             if(pullYdistance > this.didsomethingY){
                                this.textview = this.upText;
                                !!(this.status!=2) && this.v_changeStatus(2);
                             }else{
                                this.textview = this.downText;
                                !!(this.status!=1) && this.v_changeStatus(1);
                             }
                     }

                     !!this.onPulling && this.onPulling(pullYdistance)
                   
                     if(e){
                        e.preventDefault();
                     }
                     

             }else{ //在刷新的时候 会出现该逻辑
       
                 this.textview = this.downText;
                 this.v_changeStatus(0);
                 this.distanceY = 0;
             } 
         }else{   //开始，或结束 
            if(dom.scrollTop == 0){
              this.textview = this.downText;
              this.v_changeStatus(1);
            }
         } 
    },
    v_onTouchEnd (){
       this.bAnimation = true;
       if(!!this.status){
          let bend = !!this.v_didsomeAction ? this.v_didsomeAction() : false;

          !!bend ? this.textview = this.loadingText : this.textview = this.downText;

          this.distanceY = !!bend ? this.didsomethingY :0;
       }

       this.btouching = false;
    },
    v_onScrollaction (){
      let scrollTop =  Math.ceil(dom.scrollTop);
      let clientHeight = window.innerHeight;
      let scrollHeight = dom.scrollHeight;
      if(scrollTop > this.lastScrollTop){
         this.v_onScrollUp();
      }else{
          this.v_onScrollDown();
      }

      if(scrollTop+clientHeight+this.bottomdistance >= scrollHeight){
         this.v_tobuttomAction(this.tobuttomActionEnd)
      }
        this.lastScrollTop = scrollTop;
    },
    v_tobuttomAction (fname){
      !!fname && fname();
    },
    v_done (){

    },
    v_onScrollUp(){

    },
    v_onScrollDown(){

    },
    endRefreshFn (){
       this.bendAction = true;
        this.textview = this.downText;
        this.distanceY = 0;
        this.v_changeStatus(0);
        !!this.endRefreshAction && this.endRefreshAction();
    },
    v_didsomeAction (done){
      if(this.distanceY > this.didsomethingY) {
         this.v_changeStatus(3);
         if(!!this.bendAction) {
            this.bendAction = false;
            !!this.didSomeAction && this.didSomeAction(done);
         }
         return true;
      }else{
        this.v_changeStatus(0);
        this.btouching = false;
        return false;
      }
    },
    v_changeStatus(data){
 
        this.status = data;
        !!this.onPullStatusChange && this.onPullStatusChange(data);
    },
  }
}
</script>

<style>
   .refreshview{
      -webkit-transition: -webkit-transform 400ms;
transition: transform 400ms;
    }
  .drop-refresh-sign{
    position: absolute;
    left: 0;
    top: -40px;
    width: 100%;
    height: 40px;
    color: #666;
  }
  .drop-refresh-sign>div{
    text-align: center;
    line-height: 40px;
    height: 40px;
    font-size: 12px;
  }
  .drop-refresh-sign>div>i.down,.drop-refresh-sign>div>i.up{
  display: inline-block;
  width: 13px;
  height: 16px;
  background: no-repeat center;
  -webkit-transform: rotate(0deg) translate3d(0, 0, 0);
  transform: rotate(0deg) translate3d(0, 0, 0);
  -webkit-transition-duration: 300ms;
  transition-duration: 300ms
  }
  .drop-refresh-sign>div>i.down,.drop-refresh-sign>div>i.up{
   vertical-align: top;
  margin-top: 12px;
  position: relative;
  }
  .drop-refresh-sign>div>i.up{
  -webkit-transform: rotate(180deg) translate3d(0, 0, 0);
  transform: rotate(180deg) translate3d(0, 0, 0)
  }
  
  .drop-refresh-sign>div>i.down:before,.drop-refresh-sign>div>i.up:before{
    position: absolute;
    left: 2px;
    bottom: 2px;
    border-right: 1px solid #666;
    border-bottom: 1px solid #666;
    -webkit-transform: rotate(45deg);
    transform: rotate(45deg)
  }
  .drop-refresh-sign>div>i.down:before,.drop-refresh-sign>div>i.up:before{
    content: "";
    width: 8px;
    height: 8px
  }
  .drop-refresh-sign>div>i.down:after,.drop-refresh-sign>div>i.up:after{
    content: "";
    display: block;
    margin: 0 auto 2px;
    width: 1px;
    height: 14px;
    background-color: #666
  }

  .drop-refresh-sign>div>i.refresh{
     vertical-align: top;
      margin-top: 10px;
      display: inline-block;
    width: 20px;
    height: 20px;
    -webkit-transform-origin: 50%;
    transform-origin: 50%;
    -webkit-animation: small-loading-spin 1s steps(12, end) infinite;
    animation: small-loading-spin 1s steps(12, end) infinite;
    
  }
  @keyframes small-loading-spin {
      0%{-webkit-transform:rotate(0);transform:rotate(0)}
        100%{-webkit-transform:rotate(360deg);transform:rotate(360deg);}
       
    }

  .drop-refresh-sign>div>i.refresh:after{
    background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg%20viewBox%3D%220%200%20120%20120%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%3Cdefs%3E%3Cpath%20id%3D%22a%22%20stroke%3D%22%236c6c6c%22%20stroke-width%3D%2211%22%20stroke-linecap%3D%22round%22%20d%3D%22M60%207v20%22%2F%3E%3C%2Fdefs%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.27%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.27%22%20transform%3D%22rotate(30%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.27%22%20transform%3D%22rotate(60%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.27%22%20transform%3D%22rotate(90%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.27%22%20transform%3D%22rotate(120%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.27%22%20transform%3D%22rotate(150%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.37%22%20transform%3D%22rotate(180%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.46%22%20transform%3D%22rotate(210%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.56%22%20transform%3D%22rotate(240%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.66%22%20transform%3D%22rotate(270%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.75%22%20transform%3D%22rotate(300%2060%2060)%22%2F%3E%3Cuse%20xlink%3Ahref%3D%22%23a%22%20opacity%3D%22.85%22%20transform%3D%22rotate(330%2060%2060)%22%2F%3E%3C%2Fsvg%3E");
    display: block;
    content: "";
    width: 100%;
    height: 100%;
    background-position: 50%;
    background-size: 100%;
    background-repeat: no-repeat;
  }
  
  .drop-refresh-sign>div>span{
    margin-left: 5px
  }
</style>
