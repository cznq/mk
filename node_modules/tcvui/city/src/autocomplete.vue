<template>
      <div>
          <div style="height:56px">
                  <div :class="['search '+(autoIsOpen?'':'search-reset')]">
                    <input
                      ref="outautoInput"
                      :value = "value"               
                      :placeholder="title"
                      v-on:focus='v_onfocus($event)'   
                      v-on:input = 'v_oninput($event)'
                      @keyup.up = 'ArrowUp($event)'
                      @keyup.down = 'ArrowDown($event)'
                      @keyup.enter = 'Enter($event)'
                      @keyup.esc = 'Escape($event)'
                      @click = 'v_onfocus($event)'
                     />
                     <span class="search-icon"></span>
                    <span class="clear" @click="clearAction"><i>×</i></span>
                    <span class="cancel" @click="hide">取消</span>
                  </div>
         </div>
         <div class="search-complete" v-bind:style="{display:autoIsOpen?'block':'none'}">
            <div id="autoComplete" class="autofill-wrap" v-bind:style="{display:autoIsOpen?'block':'none'}"
              
            >
              <div class="show-title">
                <span class="autofill-hd-inner">{{this.title}}</span>
                <span class=""></span>
              </div>
              <table class="autofill-tray" cellPadding="0" cellSpacing="0">
                <tbody ref="resultDataItems">

                  <tr :class="getClassNames(i)" v-for="(value,i) in resultData" v-on:touchstart="touchStart" v-on:touchend="touchEnd(i)"><td><div>{{itemValue(value)}}</div></td></tr>


                </tbody>
              </table>
            </div>
          </div>
        </div>
</template>

<script>

export default {
 name: 'TcAutocomplete',
 data () {

    return {
      autoIsOpen:false,
      highlightedIndex:null,
      isFirst:true,
      reset:false,
      printData:[],
      resultData:[],
      value:'',
      startT:'',
      origin:'',
      matchFalid:false,
      matchLength:undefined
    }
  },
   mounted (){
       //  console.log(this.$el.querySelector('.'+this.itemClass))
   },
  props:{
   title:{
       default: '输入中文/拼音',
      type:String
   },
   itemClass:{
      default:'autofill_item',
      type:String
   },
   highlightClass:{
     default:'autofill-hover',
      type:String
   },
   on_Focus:{
      default: ()=>{},
      type:Function
   },
   onShowFn:{
      default: ()=>{},
      type:Function
   },
   onCancel:{
     default: ()=>{},
      type:Function
   },
   defaultData:Array,
   max:{
    default: 999,
      type:Number
   },
   itemPrintFn:{
      default: ()=>{},
      type:Function
   },
   itemValue:{
      default: ()=>{},
      type:Function
   },
   localData:Array,
   ignore:{
      default: true,
      type:Boolean
   },
   selectItemFn:{
     default: ()=>{},
      type:Function
    },
    maxOverFlowNum:{
      default: 10,
      type:Number
    },
    sortFn:{
      default:null,
      type:Function
    },
    preSortFn:{
      default:null,
      type:Function
    },
    showUserInput:{
       default: false,
      type:Boolean
    },
    url:{
      default:'',
      type:String
    }
  },
  methods:{
      clearAction(){
          this.setInputValue('');
      },
      touchStart (){
        this.startT = new Date().getTime();
      },
      getFilteredItems (){
        return this.resultData;
      },
     ArrowUp (event){
        event.preventDefault()
        const length = this.getFilteredItems().length;
        if (!length) return
        let { highlightedIndex } = this;
        let index = (
          highlightedIndex === 0 ||
          highlightedIndex === null
        ) ?  length-1 : highlightedIndex - 1

        this.highlightedIndex = index;
        this.autoIsOpen = true;
        !!this.onShowFn && this.onShowFn();
     },
     ArrowDown (event){
        event.preventDefault()
        const length = this.getFilteredItems().length;
        if (!length) return
        let { highlightedIndex } = this;
        let index = (
          highlightedIndex === null ||
          highlightedIndex === length - 1
        ) ?  0 : highlightedIndex + 1

        this.highlightedIndex = index;
        this.autoIsOpen = true;
        !!this.onShowFn && this.onShowFn();

     },
     Enter (event){
     
         if (this.autoIsOpen === false) {
            return
          }else if (this.highlightedIndex == null) {
            this.autoIsOpen = false;
            this.$refs.outautoInput.select()

          }else{
            event.preventDefault();
            let itemObj = this.getFilteredItems()[this.highlightedIndex];
            let value = this.itemValue(itemObj)
            this.autoIsOpen = false;
            this.value = value;
            this.highlightedIndex = null;
            this.selectItemFn()
           
          }
     },
     Escape (e){
        this.hide();
     },
     trim(str,is_global)
        {
            var result;
            result = str.replace(/(^\s+)|(\s+$)/g,"");
            if(is_global.toLowerCase()=="g")
            {
                result = result.replace(/\s/g,"");
             }
            return result;
      },
     isArray(obj) { 
      return Object.prototype.toString.call(obj) === '[object Array]';   
     },

     isObject(obj) {
       return Object.prototype.toString.call(obj) === '[object Object]';   
     },
    v_onfocus(e){
      if(this.defaultData.length !== 0 ){
         this.show();
      }
    },
    v_onblur(e){
      this.hide();
    },
    setInputValue (value){
      this.value = value
    },
    keyEvent (){

    },
    v_oninput (event){
  
      if(this.getValue() == ''){  //删除到最后
          this.show();
          if(this.defaultData.length !== 0){
             this.matchData(this.getValue(),this.defaultData)
          }else{
             this.hide();
              console.log(1)
              this.setInputValue(event.target.value);
              return
          }
      }else{
        this.show();
      }
      this.setInputValue(event.target.value);
      if(this.url){
          this.ajaxToGetData(this.url)
      }else{
          console.log(123)
          this.matchData(this.getValue(),this.localData);
      }
      
    },
    getValue (value){
      let node = this.$refs.outautoInput;
      if(!!value){
         node.value = value;
      }else{
         return this.trim(node.value,'g');
      }
    },
    matchData (key, data){
      
        let fData;
        if(this.ignore){
           key = key.toLowerCase();
        }
        if(key == ''){
          fData = this.defaultData;
        }else{
          fData = this.sub_matchData(key,data);
        }
        origin = key;
        let key1 = key;
        if(key.length > this.maxOverFlowNum){
           key1=key.substring(0,this.maxOverFlowNum)+"...";
        }
        if(fData.length){
           if(this.sortFn){
             fData.sort(this.sortFn);
           }
           if(this.matchFalid){
            console.log(112)
              this.bulidTitleTips('对不起，找不到：' + key1);
           }else{
            console.log(11)
              this.bulidTitleTips(this.showUserInput && key != "" ? key + "，" + this.title : this.title);
           }
           this.bulidTableList(fData, key.substr(0, this.matchLength),0);
        }else{
           this.bulidTitleTips('对不起，找不到：' + key);
        }
        key1=null;
    },
    sub_matchData (key, data){

         let fData = [],
               tempCity, tempMatch, tempKey, tempMatchIndex, tempTempMatchIndex,
               tempMatchKey, matchKeyPri,
                iLength, jLength, k, kLength;  //。。。。。。
               let mData = data;
               iLength = mData.length;
          for(let i=0; i<iLength;i++){
            tempCity = mData[i];
             tempMatch = tempCity.match;
             jLength = tempMatch.length;
             tempMatchIndex = -1;
             //关键字
              for(let j=0; j<jLength; j++){
                  tempKey = tempMatch[j];
                  if(this.ignore){
                         tempKey = tempKey.toLowerCase();
                  }
                  //找到最靠前的匹配
                  if( (tempTempMatchIndex = tempKey.indexOf(key)) > -1  && ((tempMatchIndex === -1) || (tempTempMatchIndex < tempMatchIndex)) ){
                         tempMatchIndex = tempTempMatchIndex;
                         tempMatchKey = tempKey;
                     }
              }
              if(tempMatchIndex > -1){
                   if(this.preSortFn){
                       this.preSortFn(tempCity, tempMatchKey, tempMatchIndex);
                   }
                   fData[fData.length] = tempCity;
               }

          }
          if(!fData.length){
               key = key.substr(0, key.length - 1);
               if(key !== ""){
                        fData = this.sub_matchData(key,mData);
                    }
              this.matchFalid = true;
          }else{
              this.matchFalid = false;
              this.matchLength = key.length;
          }
          return fData;

    },
    hide (){
      this.autoIsOpen = false;
      !!this.onCancel && this.onCancel();
    },
    show (){
      if(!this.autoIsOpen){
         this.autoIsOpen = true;
         !!this.onShowFn && this.onShowFn();
      }

      if(!!this.isFirst && this.defaultData.length!=0){
        this.bulidTitleTips(this.title);
        this.bulidTableList(this.defaultData,'',0);
        this.isFirst = false;
      }else if(this.reset){
        this.bulidTableList(this.defaultData,'',0);
        this.bulidTitleTips('');
      }

      var ele = this.$el.querySelector('.'+this.itemClass);
      console.log(ele)
    },
    bulidTitleTips (html,before){
       this.title = html;
    },
    bulidTableList (fData, highLightKey, num){
      if(fData && this.processPrintDataFn){
        this.processPrintDataFn(fData)
      }
      this.printData = fData;
      let allList = [],list = [];
            for(let x = 0 ,y = fData.length;x < y ; x++){
                let z = list.length;
                list[z] = fData[x];
                if(z == (this.max - 1) || x == (fData.length - 1)){
                    allList[allList.length] = list;
                    list = [];
                }
            }
            
            this._bulidTableList(allList, highLightKey,num);
    },
    _bulidTableList (fData, highLightKey,num){

      let _num = num ? num :0;
      if(fData[_num] && fData[_num].length){
         let total = [];
         for(let i=0; i<fData[_num].length;i++){
           let temp = this.itemPrintFn(fData[_num][i]);
           total.push(temp);
         }
         this.resultData = total;
         
      }
    },
    getClassNames (i){
      return this.highlightedIndex==i?this.itemClass+' '+this.highlightClass:this.itemClass;
    },
    getcloseAction (){

    },
    touchEnd (i){
      let nowTime = new Date().getTime();
      if(nowTime-this.startT <=300){
          let itemObj = this.getFilteredItems()[i];
          let value = this.itemValue(itemObj)
          this.autoIsOpen = false;
          this.value = value;
          this.highlightedIndex = null;
          this.selectItemFn();
      }
    }
  }
 }
</script>

<style>
.autofill-wrap{position:absolute;background-color:#FFF;font:12px/24px SimSun;width:100%;border:1px solid #ccc}.autofill-close{position:absolute;width:11px;height:11px;top:7px;right:10px;background:url(//img1.40017.cn/touch/public/autoComplete/pic.png?v=2) 0 -16px repeat scroll;cursor:pointer}.autofill-hd-inner{color:#999;font-size:12px;padding:0 10px;display:block}.autofill-tray{background:#fff;width:100%}.autofill-tray th{padding:0 10px}.autofill-tray th{border-bottom:1px solid #ddd}.autofill-tray th,.autofill-tray td,.autofill-hd-inner{white-space:nowrap;overflow:hidden}.autofill-tray td{color:#333}.autofill-tray .ltd{text-align:left}.autofill-tray .rtd{text-align:right}.autofill-hover{background-color:#e2e2e2}.autofill-hili{color:#f60;cursor:pointer}.autofill_item{line-height:30px;border-bottom:1px solid #ccc;padding-left:15px;display:block}.item-state-hover td{background-color:#e2e2e2}.show-title{border-bottom:1px solid #ccc}


</style>