<template>
  <div>
   <div id="cityPage" class="page"></div>
   <TcAutocomplete
     v-if="this.hasSearch && this.autoCompleteData"
    :on_Focus = "on_Focus"
    :defaultData = "defaultCity"
    :itemValue = "itemValue"
    :itemPrintFn = "buildCityItem"
    :localData = "autoCompleteData"
    :onShowFn = "autofocus"
    :selectItemFn = "closeComplete"
    :onCancel = "closeComplete"
   >
   </TcAutocomplete>
   <div v-if="!!this.dbList">
           <div :class="check_city_wrap()">
			   <ul class="city-tab clearfix">
			                  <li :class="this.check_tab_btn(0)" @click="tabAction(0)">国内城市</li>
			                  <li :class="this.check_tab_btn(1)" @click="tabAction(1)">国际城市</li>
			   </ul>
			   <div class="c-wrapper-posr" v-bind:style="{height:(windowHeight-56-40)+'px'}">
                   <div ref="cityWrap" :class="['city-wrapper c-wrapper '+this.check_tab_cont(0)]">
                   		 <div>
                          <h3 class="city-key-dw">当前</h3>
                          <ul class="dw-city">
                            <li v-if="!!cityDatas" v-for="(item, i) in cityDatas" @click="clickFnBack(item)">
                            <span>{{item['data-cityName']}}</span>
                            <span style="marginLeft:'15px'">GPS定位</span>
                            </li>
                            <li class="disabled" v-if="!cityDatas && !!this.cityData && !this.errorcityData" @click="clickFnBack(cityData)"><span>{{this.cityData['data-cityName']}}</span><span style="marginLeft:'15px'">GPS定位</span></li>
                            <li class="disabled" v-if="!!this.errorcityData"><span>定位到的城市{{this.errorcityData}}不符合要求</span></li>
                            <li class="disabled" v-if="!this.cityData && !this.errorcityData && this.hasLocation == 1"><span>正在获取位置信息</span></li>
                             <li v-if="!this.cityData && !this.errorcityData && this.hasLocation != 1 && !this.tips" class="disabled get-location" @click="this.getDwCity">
	                          <span>点击获取当前位置</span>
	                         </li>
	                         <li v-if="!this.cityData && !this.errorcityData && this.hasLocation != 1 && this.tips && !this.reject" class="disabled retry" @click="this.getDwCity">
	                          <span>{{this.tips}}(点击重试)</span>
	                         </li>
	                         <li v-if="!this.cityData && !this.errorcityData && this.hasLocation != 1 && this.tips && this.reject" class="disabled">
	                          <span>{{this.tips}}</span>
	                         </li>
                          </ul>
                         </div>
                         <Cities ref="cities" v-if="!!this.cityObjArray"
                              :index = 0
                              :loadCity = "loadCity"
                              :mode = "_mode"
						      :citiesObjArray = "cityObjArray"
						      :citiesletterArray = "cityNavObjArray"
						      :callbackData = "callbackData"
                  :clickFn = "clickFnBack"
						      :getlistCity = "getlistCity"
                  :key = "this.tabindex"
                         ></Cities>
		           </div>
		           <div ref="icityWrap" :class="['icity-wrapper c-wrapper '+this.check_tab_cont(1)]">
                      <Cities ref="cities" v-if="!!this.icityObjArray"
                              :index = 1
                              :loadCity = "loadCity"
                              :mode = "_mode"
                  :citiesObjArray = "icityObjArray"
                  :citiesletterArray = "icityNavObjArray"
                  :callbackData = "callbackData"
                  :clickFn = "clickFnBack"
                  :getlistCity = "getlistCity"
                  :key = "this.tabindex"
                         ></Cities>        
               </div>
			   </div>
           </div>
           <div :class="['city-nav gcity-nav nav-fixed-top '+this.check_nav_bar(0)]">
                                <CityNav v-if="!!this.cityNavObjArray"
                                  :index = 0
                                  :mode = "_mode"
                                
                                  :cityNavObjArray = "cityNavObjArray"
                                  :scrollAnimate = "_scrollAnimate"
                                />
           </div>
           <div :class="['city-nav icity-nav nav-fixed-top '+this.check_nav_bar(1)]">
                   <CityNav v-if="!!this.icityNavObjArray"
                                  :index = 1
                                  :mode = "_mode"
                          
                                  :cityNavObjArray = "icityNavObjArray"
                                  :scrollAnimate = "_scrollAnimate"
                                />              
            </div>
    </div>
    <div v-else="!this.dbList">
            <div :class="check_city_wrap()">
	            <div class="c-wrapper-posr" v-bind:style="{height:(windowHeight-56)+'px'}">
	                 <div class="city-wrapper c-wrapper" ref="cityWrap">
	                    <div v-if="this.hasLocation">
	                       <h3 class="city-key-dw">当前</h3>
	                       <ul class="dw-city">
                         <li v-if="!!cityDatas" v-for="(item, i) in cityDatas" @click="clickFnBack(item)">
                            <span>{{item['data-cityName']}}</span>
                            <span style="marginLeft:'15px'">GPS定位</span>
                            </li>
	                         <li class="disabled" v-if="!cityDatas && !!this.cityData && !this.errorcityData" @click="clickFnBack(cityData)"><span>{{this.cityData['data-cityName']}}</span><span style="marginLeft:'15px'">GPS定位</span></li>
	                         <li v-if="!!this.errorcityData" class="disabled">
	                           <span>定位到的城市{{this.errorcityData}}不符合要求</span>
	                         </li>
	                         <li v-if="!this.cityData && !this.errorcityData && this.hasLocation == 1" class="disabled">
	                          <span>正在获取位置信息</span>
	                         </li>
	                         <li v-if="!this.cityData && !this.errorcityData && this.hasLocation != 1 && !this.tips" class="disabled get-location">
	                          <span>点击获取当前位置</span>
	                         </li>
	                         <li v-if="!this.cityData && !this.errorcityData && this.hasLocation != 1 && this.tips && !this.reject" class="disabled retry">
	                          <span>{{this.tips}}(点击重试)</span>
	                         </li>
	                         <li v-if="!this.cityData && !this.errorcityData && this.hasLocation != 1 && this.tips && this.reject" class="disabled">
	                          <span>{{this.tips}}</span>
	                         </li>
	                       </ul>
	                    </div>
	                     <Cities ref="cities" v-if="!!this.cityObjArray"
                              :index = 0
                              :loadCity = "loadCity"
                              :mode = "_mode"
                  :citiesObjArray = "cityObjArray"
                  :citiesletterArray = "cityNavObjArray"
                  :callbackData = "callbackData"
                  :clickFn = "clickFnBack"
                  :getlistCity = "getlistCity"
                  :key = "this.tabindex"
                         ></Cities>
	                 </div>
	            </div>
           </div>
           <div :class="['city-nav gcity-nav nav-fixed-top '+this.check_nav_bar(0)]">
                    <CityNav v-if="!!this.cityNavObjArray"
                                  :index = 0
                                  :mode = "_mode"
                                
                                  :cityNavObjArray = "cityNavObjArray"
                                  :scrollAnimate = "_scrollAnimate"
                                />                      
           </div>
    </div>
  </div>
</template>

<script>
import TcAutocomplete from './autocomplete.vue'
import Cities from './cities.vue'
import CityNav from './citynav.vue'
import location from 'tcvui/util/location/location';
import {windowHeight,windowWidth} from '../../utils/dom';

//console.log(windowHeight())
export default {
  name: 'TcCity',
  data (){
     return {
       defaultCity:[],
      localData:[],
      hideCityWrap:false,
      currentIndex:0,
      cityData:null,
      cityDatas:null,
      errorcityData:null,
      cityNavObjArray:null,
      windowHeight:windowHeight(),
      cityObjArray:null,
      asynHotcities:null,
      extendCitiesReady:false,
      citiesReady:false,
      icityObjArray:null,
      icityNavObjArray:null,
      _mode:null,
      completeData:[],
      autoCompleteData:[],
      domTop:[],
      tabindex:0,
      tips:'',
      reject:false,
      asynCities:'',
     }
  },
   props:{
	   hasSearch:{
	       default: true,
	       type:Boolean
	   },
	   dbList:{
	   	 	default: false,
	        type:Boolean
	   },
	   hasLocation:{
	   	 	default: true,
	        type:Boolean
	   },
	   letters:{
		   	type: Array,
	        default() {
	          return ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
	        }
	   },
	   extendCities:{},
     cities:{},
		mode:{
  		default: '',
     
  		},
	   hasLocation:{
	   	  default:1
	   },
     pyAttr:{
        type:Number,
        default:3
     },
	   nameAttr:{
	   		default: 1,
	        type:Number
	   },
	   dataAttrMap:{
	   	type: Object,
	    default() {
	          return {
	          	 id: 0,
	            name: 1
	          };
	        }
	   },
     locConfig:Object,
     loc:{type: Object,
          default() {
            return {}
          }},
     matchAttrs:{
      type: Array,
          default() {
            return ["name", "fullPy", "shortPy"]
          }
     },
     hotCityFilter:{
        type:Function,
       default:function(hotCity, city) {
                                return hotCity === city[this.nameAttr];
                            }
     },
     cityFilter:{
       type:Function,
       default:function (city) {
                                return true;
                            }
     },
     clickFn:{
       type:Function,
       default:()=>{}
     }
   },
   components:{
      "TcAutocomplete": TcAutocomplete,
      "Cities": Cities,
      "CityNav":CityNav
    },
     beforeMount(){
     	this._mode = this.mode;
     },
    mounted(){
   
    	if(this._mode == 'asRequired'){
    		
    		 if (this.isArray(this.extendCities)) {
                 this.extendCitiesReady = true;
	                // citiesReady = true;

	                this.asynHotcities = this.extendCities;
	                this.buildList();
	               
	        }else{
	           if(this.isObject(this.extendCities)){

	              this.loadHotCity(this.buildList)
	           }
	        }
	      return;
    	}


       if(this.isArray(this.extendCities)){
      
             this.extendCitiesReady = true;   // 热门城市数据准备好了

        }else{
           if(this.isObject(this.extendCities)){
             
           }else{
            
               this.extendCitiesReady = true;   // 热门城市数据准备好了
           }
        }
        if (this.isArray(this.cities)) {
                    this.citiesReady = true; // 城市数据准备好了
                    this.buildCity();
                
        }
    },
   methods:{
     clickFnBack(data){
       this.clickFn(data);
     },
     closeComplete() {
     this.hideCityWrap = false;
    },
     autofocus (){
        this.hideCityWrap = true;
     },
     tabAction (i){
      
       this.currentIndex = i;
       this.tabindex = i;


     },
     _scrollAnimate (i,index){
       let node = index==0?this.$refs.cityWrap:this.$refs.icityWrap;

     
        if(this.domTop[index][i]==undefined){
          this.domTop[index][i] = 0;
        }
        this.scrollAnimate(node,{toT:this.domTop[index][i]})
     },
     scrollAnimate (node, options){
      let defaults = {
            toT : 0,    //滚动目标位置
            durTime : 500,  //过渡动画时间
            delay : 30,     //定时器时间
            callback:null   //回调函数
        };
    let opts = Object.assign(defaults, options),
        timer = null,
        curTop = node.scrollTop,//滚动条当前的位置
        subTop = opts.toT - curTop,    //滚动条目标位置和当前位置的差值
        index = 0,
        dur = Math.round(opts.durTime / opts.delay),
        smoothScroll = function(t){
                index++;

                var per = Math.round(subTop/dur);
                if(index >= dur){
                 
                    node.scrollTop=t;
                    window.clearInterval(timer);
                    if(opts.callback && typeof opts.callback == 'function'){
                        opts.callback();
                    }
                    return;
                }else{
                    node.scrollTop = (curTop + index*per);
                }
            };
        timer = window.setInterval(function(){
            smoothScroll(opts.toT);
        }, opts.delay);
     },
   	  getlistCity (){
    	   var self = this;
       setTimeout(function(){
            self.closeComplete();
            },300);
	  },
   	callbackData(data) {

     this.domTop = data;
   	},
      processGetData(data,data2){
              if(!data2){return }
              var reqs = data.param.reqbody;
              if(reqs){
                  reqs = typeof reqs === 'string' ? JSON.parse(reqs) : reqs;
                  data.param.reqbody = Object.assign(reqs,data2)
              }else{
                  data.param.reqbody = data2
              }
   },
   	 loadCity (fn, key, country, i){
     var self = this;
            let ajaxObj = Object.assign({},self.cities);
             
            let PDATA = ajaxObj.processData({
               cityKey: key,
               country:country
            })
            this.processGetData(ajaxObj,PDATA);

           
            fetch(ajaxObj.ajaxObj.url,ajaxObj.param).then(function(data){
                if(self.cities.callback){
                  data = self.cities.callback(data) || data;
                }
           
                 self.asynCities = data;
                 self.citiesReady = true;
             
                fn(self.createrequireByLetter(data),key,i);
            })
          

   	 },
     createrequireByLetter(cities) {

       let arr = [];
                for (let i = 0, len = cities.length; i < len; i++) {
                    let city = cities[i];
                    if (!this.cityFilter(city)) {
                        continue;
                    }
                    // autoComplete数据源
                    this.completeData.push(this.createMatchObj(city));

                    arr.push(this.buildCityItem(city));
                }
     
                this.autoCompleteData = this.completeData
                return arr;
    },
   	 buildList(){

		   	 	if (!this.extendCitiesReady) {
		                return;
		    }

		    let HotArr = [], // 按字母分类之后数组集合
		        iHotArr = [];
		    let hcities = this.asynHotcities || [];
		    if(this.dbList){
		                HotArr = this.createHotStr(hcities[0])
		                iHotArr = this.createHotStr(hcities[1])
		    }else{
            
		                HotArr = this.createHotStr(hcities[0]);
		    }
	
		    let letters,letter;
		    letters = this.letters;
		   
		    let htmlStr =[],iHtmlStr=[],cityNavHtmlStrs = [],icityNavHtmlStrs=[];
		    if(iHotArr && !!iHotArr.length){
		              for(let i=0,len=iHotArr.length;i<len;i++){
		                iHtmlStr.push(iHotArr[i])
		                icityNavHtmlStrs.push(iHotArr[i][0].title);
		              }
		            }
		            if(HotArr && !!HotArr.length){
		               for(let i=0,len=HotArr.length;i<len;i++){
		                  htmlStr.push(HotArr[i]);
		                  cityNavHtmlStrs.push(HotArr[i][0].title);
		               }
		                
		            }
		    for(let i=0, len = letters.length;i<len;i++){
		      letter = letters[i];
		      let arr = [];
		      htmlStr.push(arr)
		      iHtmlStr.push(arr)
		      cityNavHtmlStrs.push(letter)
		      icityNavHtmlStrs.push(letter)
		    }
		   
		     this._mode = true;
		     this.cityObjArray = htmlStr;
		     this.cityNavObjArray = cityNavHtmlStrs;
		     this.icityObjArray = iHtmlStr;
		     this.icityNavObjArray = icityNavHtmlStrs;
		    if (this.hasLocation === 1) {
		                this.getDwCity();
		    }

   	 },
     buildCity (){
           if (!this.extendCitiesReady || !this.citiesReady) {
                return;
           }
           let cities; 
           if(this.isObject(this.cities)){
              cities = cities;
           }else{
              cities = this.cities;
           }
                    let city,
                        index,
                        htmlStrs = [], // 按字母分类之后数组集合
                        ihtmlStrs = [],
                        cityNavHtmlStrs = [], //国内侧边abc
                        icityNavHtmlStrs = [],
                        htmlStr = [], hotHtmlStr = '', ihotHtmlStr = '',iHtmlStr=[];

          
           let iHotArr = [],
            HotArr = [];
         

          if(this.dbList){
                        htmlStrs = this.createByLetter(cities[0]);
                        ihtmlStrs = this.createByLetter(cities[1]);
                        HotArr = this.createHotStr(this.extendCities[0]);
                        iHotArr = this.createHotStr(this.extendCities[1]);


          }else{
               if(this.isArray(cities)){
                            cities = cities[0]
                }
               let hotcit = this.extendCities;
                        if(this.isArray(hotcit)){
                            hotcit = hotcit[0]
                        }
                        htmlStrs = this.createByLetter(cities)
                        HotArr = this.createHotStr(hotcit)
            }
            
              hotHtmlStr = HotArr;
              ihotHtmlStr = iHotArr;
                    if(ihotHtmlStr && !!ihotHtmlStr.length){
                      for(let i=0,len=ihotHtmlStr.length;i<len;i++){
                        iHtmlStr.push(ihotHtmlStr[i])
                        icityNavHtmlStrs.push(ihotHtmlStr[i][0].title);
                      }
                    }
                    if(hotHtmlStr && !!hotHtmlStr.length){
                       for(let i=0,len=hotHtmlStr.length;i<len;i++){
                          htmlStr.push(hotHtmlStr[i]);
                          cityNavHtmlStrs.push(hotHtmlStr[i][0].title);
                       }
                        
                    }
                    let letter;
                    for(let i = 65; i < 91; i++) {
                       letter =  String.fromCharCode(i);
                       if(htmlStrs[i - 65]) {
                        cityNavHtmlStrs.push(letter);
                        htmlStr.push(htmlStrs[i - 65])
                       }
                       if (ihtmlStrs[i - 65]) {
                            icityNavHtmlStrs.push(letter);
                            iHtmlStr.push(ihtmlStrs[i - 65])
                        }
                    }
              
                   this.cityObjArray = htmlStr;
                   this.cityNavObjArray = cityNavHtmlStrs;
                   this.icityObjArray = iHtmlStr;
                   this.icityNavObjArray = icityNavHtmlStrs;


                    var topHeight = 62;
                    if(this.dbList && ihotHtmlStr){ //第二页city

                        
                        topHeight += 38;
                    }
                    !this.hideNavbar && (topHeight += 45);
                 
                    if (this.hasLocation === 1) {
                        this.getDwCity();
                    }
     },
   	 loadHotCity(fn){
     var self = this;
         let ajaxObj = Object.assign({},self.extendCities);
        
             fetch(ajaxObj.ajaxObj.url,ajaxObj.param).then(function(data){

                if (self.extendCities.callback) {
                    data = self.extendCities.callback(data) || data;
                }
                self.asynHotcities = data;
                self.extendCitiesReady = true;
                fn();
             })
          
   	 },
   	 createHotStr(arr){
   	 	 if(!arr){
            return ''
        }
        var cities = arr,
            hotHtmlStr = [];
        for (let i = 0, len = cities.length; i < len; i++) {
           var citylist = cities[i].citylist;
           var hotHtmlStrArr = [];
           for(let j=0,len = citylist.length; j<len; j++){
              hotHtmlStrArr.push(this.buildExtendCityItem(citylist[j],cities[i].title,cities[i].cellTypre));
           }
           hotHtmlStr.push(hotHtmlStrArr) 
        }
    
        if(!hotHtmlStr.length){
            return '';
        }
        return hotHtmlStr;
   	 },
     createByLetter (cities,indexs){

         let arr = [];
            for (let i = 0, len = cities.length; i < len; i++) {
                let city = cities[i];
                if (!this.cityFilter(city)) {
                    continue;
                }
                // autoComplete数据源
                this.completeData.push(this.createMatchObj(city));

                 let index = city[this.pyAttr].toUpperCase().charCodeAt(0) - 65;

                if (arr[index] === undefined) {
                    arr[index] = [];
                }
              
                arr[index].push(this.buildCityItem(city));
                this.getHotCity(city,indexs);
            }
         
            this.autoCompleteData  = this.completeData;
           
            return arr;
     },
     getHotCity(city,index) {

            if (!this.hotCityFilter) {
                return;
            }
            let extendCities = this.extendCities;
            if(index || index === 0){
                extendCities = this.extendCities[index]
            }
            for (let i = 0, len = extendCities.length; i < len; i++) {
                if (this.hotCityFilter(extendCities[i], city)) {
                    extendCities[i] = city;
                    break;
                }
            }
        },
     isEmptyObject(obj){
        return !!obj.tcvui
     },
   	 getDwCity (){
        debugger;
          var self = this;
          var obj = Object.assign({
            time:1,
          },self.locConfig)
          

          location(obj).then(function(location){
       
             if(obj.processFn){
                location = lConfig.processFn(location)
              }
              if(location.tips){
                 this.reject = location.reject;
                 this.tips = location.tips
              }else{
                  var cityName = location.cityName.replace("市", "");
                  if(self.loc && self.isObject(self.cities)){

                      if(typeof self.loc === 'function'){
                                var datas = self.loc(location);
                                if(datas){
                                   
                                   let lobj = self.buildCityItem(datas);
                                            let _props={};
                                            for(let i in lobj){
                                              _props['data-'+i]=lobj[i];
                                            }
                                         
                                   self.cityData = _props;
                                }else{
                                    self.errorcityData = cityName;
                                }
                      }else if(self.isObject(self.loc)){
                        let ajaxObj = Object.assign({}, self.loc);
                        var PDATA = ajaxObj.processData({
                                    cityName:cityName,
                                    latitude:location.latitude,
                                    longitude:location.longitude
                                });
                         self.processGetData(ajaxObj,PDATA);
                         fetch(ajaxObj.ajaxObj.url,ajaxObj.param).then(function(data){
                                 if (self.loc.callback) {
                                        data = self.loc.callback(data);
                                    }
                                    if(!data || self.isEmptyObject(data)){
                                        self.errorcityData = cityName;
                                        return;
                                    }
                                     
                                    let tmp = [];
                                   
                                    for(var f in data){
                                           let lobj = self.buildCityItem(data[f]);
                                            let _props={};
                                            for(let i in lobj){
                                              _props['data-'+i]=lobj[i];
                                            }
                                            tmp.push(_props);

                                    }
                                  self.cityDatas = tmp;
                         });
                      }else{
                                var data = {};
                                data[self.dataAttrMap.id] = location[self.dataAttrMap.id] || location.cityId;
                                data[self.dataAttrMap.name] = location[self.dataAttrMap.name] || location.cityName;
                                let lobj = self.buildCityItem(data);
                                            let _props={};
                                            for(let i in lobj){
                                              _props['data-'+i]=lobj[i];
                                            }
                                  self.cityData = data;          
                            
                      }
                  }else{
                      let allCity = [];
                                      if(self.dbList){
                                          allCity = allCity.concat(self.cities[0]).concat(self.cities[1])
                                      }else{
                                          allCity = self.cities
                                      }
                                      for (var i = 0, len = allCity.length; i < len; i++) {
                                          if (allCity[i][self.nameAttr] === cityName) {
                                           let lobj = self.buildCityItem(allCity[i]);
                                            let _props={};
                                            for(let i in lobj){
                                              _props['data-'+i]=lobj[i];
                                            }
                                         
                                                self.cityData = _props;
                                              break;
                                          }
                                      }
                                      if (i === allCity.length) {
                                           
                                               self.errorcityData = cityName;
                                      }
                  }
              }
          },function(data){
            if(data.reject){
             
               self.reject = true;
               self.tips = data.tips;
            }else{
            
                self.reject = false;
               self.tips = data.tips;
            }
          })

   	 },
   	 buildExtendCityItem (city,title,cellTypre){
   	 	 let cityobj={},str='';
	      let cityName = city[this.nameAttr];
	      for (let i in this.dataAttrMap) {
	                cityobj[i] = city[this.dataAttrMap[i]]
	      }
	      if(title){
	              cityobj.title = title;
	            }
	            if(cellTypre){
	              cityobj.cellTypre = cellTypre; 
	            }
	            if(cityName){
	              cityobj.cityName = cityName + (str ? str : '');
	            }else{
	                cityobj.cityName = '暂无可选城市' + (str ? str : '');
	            }


	            return cityobj;
   	 },
      createMatchObj(city) {

      let obj = Object.assign({match: []}, city);
                for (let i = 0, len = this.matchAttrs.length; i < len; i++) {
                    obj.match.push(city[this.matchAttrs[i]]);
                }

        return obj;
     },
	 isArray(obj) { 
	  return Object.prototype.toString.call(obj) === '[object Array]';   
	 },

	 isObject(obj) {
	   return Object.prototype.toString.call(obj) === '[object Object]';   
	 },
	  check_tab_btn(index) {
	    return index===this.currentIndex?"active":'';
	  },
	  check_tab_cont(index) {
	    return index===this.currentIndex?"":'none';
	  },
   	  check_city_wrap (){
   	  	return true===this.hideCityWrap?"city-notice none":'city-notice';
   	  },
   	  check_nav_bar(index) {
	    return index===this.currentIndex && !this.hideCityWrap?"":'hidden';
	  },
      on_Focus(){
     
      },
      itemValue(item){
        return item.cityName
      },
      buildCityItem(city, tagName,str) { 

             let cityobj={};
                         let cityName = city[this.nameAttr];
                      for (let i in this.dataAttrMap) {
                     
                          cityobj[i] = city[this.dataAttrMap[i]]

                      }
                      if(cityName){
                        cityobj.cityName = cityName + (str ? str : '');
                      }else{
                          cityobj.cityName = '暂无可选城市' + (str ? str : '');
                      }
                  
                      return cityobj;
          }
   }
}
</script>
<style>
.c-wrapper-posr{position: relative;}
.search {
    padding: 8px 65px 8px 8px;
    background-color: #e0e4ec;
    position: relative;
}
.search-reset{
    padding-right: 8px;
}
.search,.city-panel{
    -webkit-user-select: none;
    -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
    -webkit-user-drag: none;
}
.search input {
    display: block;
    width: 100%;
    height: 40px;
    padding-left: 36px;
    border-radius: 5px;
    border: 0;
    box-sizing: border-box;
    font-size: 14px;
    border:1px solid #dcdcdc;
}
.search .clear {
    position: absolute;
    right: 65px;
    top: 8px;
    height: 20px;
    padding: 10px 10px;
}
.search-reset .clear {
    right: 8px;
    display: none;
}
.search .clear i {
    display: block;
    width: 21px;
    height: 21px;
    background: #ccc;
    border-radius: 50%;
    line-height: 20px;
    font-size: 20px;
    color: #fff;
    text-align: center;
    font-style: normal;
}
.search .cancel {
    position: absolute;
    width: 65px;
    height: 40px;
    top: 8px;
    right: 0;
    text-align: center;
    font-size: 18px;
    line-height: 40px;
}
.search-reset .cancel{
    display: none;
}
.search .search-icon{
    position: absolute;
    left: 18px;
    top: 20px;
    width: 12px;
    height: 12px;
    border: 1px solid #999;
    border-radius: 50%;
}
.search .search-icon:after{
    content: '';
    position: absolute;
    width: 1px;
    height: 8px;
    left: 13px;
    top: 10px;
    background: #999;
    -webkit-transform: rotate(-45deg);
    -moz-transform: rotate(-45deg);
    -ms-transform: rotate(-45deg);
    -o-transform: rotate(-45deg);
    transform: rotate(-45deg);
}
.search-complete{
    display: none;
}
.search-complete .autofill-wrap{
    border:none;
}
.search-complete table tr{
    height:44px;
    line-height:44px;
    font-size:14px;
}
.search-complete table tr div{
    font-family:微软雅黑;
    font-size:14px;
}

.city-notice{
    background: #e9ecf1;
}
.city-notice.none{display: none;}
.city-tab{
    background: #e9ecf1;
    border-width: 1px 0 1px 0;
    border-image: url('./border-dc.png') 2 0 stretch;
    line-height: 40px;
    color: #666;
    font-size: 15px;
}
.city-tab li{
    float:left;
    width: 50%;
    text-align: center;
    box-sizing: border-box;
    padding-left: 15%;
}
.city-tab li.active{color: #50b400;position: relative;}
.city-tab li:last-child{padding-left: 0;padding-right: 15%;}
.city-tab li.active:after{
    content: '';
    position: absolute;
    left: 65%;
    bottom: 0px;
    width: 100px;
    height: 2px;
    background: #50b400;
    margin-left: -50px;
}
.city-tab li:last-child:after{padding-left: 0;left: 35%;}
.city-wrapper {
    /*border-top: 1px solid #dcdcdc;*/
    position: relative;
}
.c-wrapper{
    padding-top: 8px;
    color: #666;
        position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    overflow: scroll;
    -webkit-overflow-scrolling: touch;
}
.c-wrapper.none{display: none;}
.c-wrapper h3 {
    height: 30px;
    padding-left: 20px;
    line-height: 30px;
    /*background: #f0f0f0;*/
    /*border-bottom: 1px solid #dcdcdc;*/
    color: #777;
    font-weight: normal;
}
.c-wrapper h3.city-key-dw, .c-wrapper h3.city-key-ls, .c-wrapper h3.city-key-rm{line-height: 33px;height: 33px;font-size: 12px;}
.c-wrapper .city-key:after {
    content: '';
    float: right;
    width: 11px;
    height: 11px;
    border-left: 1px solid #bbb;
    border-top: 1px solid #bbb;
    margin: 12px 16px 0 0;
    -webkit-transform: rotate(-135deg);
    transform: rotate(-135deg);
    transition: transform .2s linear;
    -webkit-transform-origin: 3px 3px;
    transform-origin: 3px 3px;
    transition: -webkit-transform .2s linear;
}
.c-wrapper .city-key.open {
    color: #50b400;
}
.c-wrapper .city-key.open:after {
    -webkit-transform: rotate(45deg);
    transform: rotate(45deg);
}
.c-wrapper li {
    /*border-bottom: 1px solid #dcdcdc;*/
    height: 44px;
    padding: 0 20px;
    line-height: 44px;
    position: relative;
    background: #fff;
}
.c-wrapper .sort-city,.c-wrapper .require-key{
    border-width: 1px 0 1px 0;
    border-image: url('./border-dc.png') 2 0 stretch;
}
.c-wrapper .require-key{border-width: 0 0 1px 0;}
.c-wrapper .sort-city li,.c-wrapper .require-city li{position: relative;overflow: hidden;}
.c-wrapper .sort-city li:before,.c-wrapper .require-city li:before{position: absolute;content: '';left: 20px;bottom: 0;height: 1px;width: 100%;
    background-image: linear-gradient(to bottom,transparent 50%,#ddd 50%);
}
.c-wrapper .sort-city li:last-child:before,.c-wrapper .require-city li:last-child:before{display: none;}
.c-wrapper li.select{
    color: #50b400;
    position: relative;
}
.c-wrapper li.select:after {
    content: "";
    position: absolute;
    width: 17px;
    height: 9px;
    right: 45px;
    top: 12px;
    border-left: 4px solid #50b400;
    border-bottom: 4px solid #50b400;
    -webkit-transform: rotate(-45deg);
    -moz-transform: rotate(-45deg);
    -ms-transform: rotate(-45deg);
    -o-transform: rotate(-45deg);
    transform: rotate(-45deg);
}
.c-wrapper .history-city-ul li.select:after, .c-wrapper .hot-city-ul li.select:after{display: none;}
.c-wrapper .dw-city{padding: 0 35px 5px 15px;}
.c-wrapper .dw-city li{
    background: #fff;
    border:1px solid #ddd;
    color: #666;
    font-size: 16px;
    border-radius: 3px;
}
.c-wrapper .dw-city li span{
    color: #999;
    font-size: 12px;
}
.c-wrapper .history-city-ul,  .c-wrapper .hot-city-ul {
    /*padding: 0 25px 0 5px;*/
    padding: 0 0 0 5px;
}
.c-wrapper .history-city-ul li, .c-wrapper .hot-city-ul li{
    padding: 0;
    margin:0 0 10px 10px;
    background: #fff;
    border: 1px solid #dcdcdc;
    border-radius: 3px;
    padding: 0 10px;
    min-width: 81px;
    height: 32px;
    line-height: 32px;
    text-align: center;
    float: left;
    box-sizing: border-box;
}
.c-wrapper .block-city li {
    margin: 5px 20px 5px 15px;
    text-align: left;
    border: 1px solid #dcdcdc;
    height: 32px;
    line-height: 32px;
}
.c-wrapper .closed {
    display: none;
}
.city-nav {
    position: fixed;
    right: 0;
    top: 62px;
    font-size: 12px;
    color: #50b400;
    background:rgba(242, 244, 247,0.7);
    padding-top: 5px;
     -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
    -webkit-transform: translateZ(0);
    -webkit-user-select: none;
    -webkit-user-drag: none;
}
.city-nav.nav-fixed-top{bottom:0;}
.city-nav.none,.city-nav.hidden{display: none;}
.city-nav li {
    line-height: 20px;
    /*padding: 0 8px;*/
    padding: 0 2px;
    text-align: center;
    position: relative;
    font-size: 16px;
}
.city-nav .nav-city-dw, .city-nav .nav-city-ls, .city-nav .nav-city-rm {font-size: 14px;}
.city-nav li span{
    position: absolute;
    right: 100%;
    top: 0;
    background: rgba(80, 180, 0,0.7);
    line-height: 20px;
    font-size: 18px;
    color: #fff;
    border-radius: 2px;
    display: block;
    text-align: center;
    white-space: nowrap;
    padding: 3px 6px;
    display: none;
}
.city-nav .nav-active span{display: block;}
.city-nav li span:after{
    content: '';
    right: -7px;
    top: 50%;
    margin-top: -4px;
    border-color: transparent transparent transparent rgba(80, 180, 0,0.7); 
    border-style: dashed dashed dashed solid; 
    border-width: 4px;
    position: absolute;
}
.search-complete .autofill-wrap{
    position: relative;
}
@media screen and (width:375px){
    .c-wrapper .hot-city-ul{
        padding: 0 0 0 11px;
    }
    .c-wrapper .hot-city-ul li{
        margin: 0 0 10px 4px;
    }
}
</style>
