<template>
<div>
<div :ref="['citiesWrap_'+index]" v-if="!!mode">
   <div v-for="(item, i) in this.citiesletterArray" :ref="['dRef'+i]">
   	  <h3 :ref = "['require_h_'+i]"
      :class="[((!!citiesObjArray[i][0] && citiesObjArray[i][0].cellTypre) ?'city-key-rm':'city-key require-key'+(i==cindex && !openArr[i]?' open':''))]" 
      @click = "requireaction(i, item)"
       >{{item}}</h3>
      <ul :ref = "['require_ul_'+i]"
      :class="[!!citiesObjArray[i][0] && citiesObjArray[i][0].cellTypre=='grid'?'hot-city-ul clearfix':!!citiesObjArray[i][0] && citiesObjArray[i][0].cellTypre=='line'?'sort-city':!!citiesObjArray[i][0] && citiesObjArray[i][0].cellTypre=='block'?'block-city':'require-city'+(i==cindex && !openArr[i]?'':' closed')]"
         >
          
                <li v-for="(item, j) in citiesObjArray[i]" @click = "callbackAction(item)">
                {{item.cityName}}
                </li>
                  
      </ul>       
    </div>
</div>
<div :ref="['citiesWrap_'+index]" v-if="!mode">
  <div v-for="(item, i) in this.citiesletterArray" :ref="['dRef'+i]">
      <h3
      :class="['city-key-'+(item=='热门' || citiesObjArray[i][0].cellTypre ?'rm':item=='历史'?'rm':item)]" 
       >{{item}}</h3>
      <ul :ref = "['require_ul_'+i]"
      :class="[citiesObjArray[i][0].cellTypre=='grid'?'hot-city-ul clearfix':citiesObjArray[i][0].cellTypre=='line'?'sort-city':citiesObjArray[i][0].cellTypre=='block'?'block-city':'sort-city']"
         >
          
                <li v-for="(item, j) in citiesObjArray[i]" @click = "callbackAction(item)">
                 {{item.cityName}}
                </li>
                  
      </ul>       
    </div>
</div>
</div>
</template>
<script>
import global_ from './Global.vue'
export default {
  name: 'Cities',
   data (){
    return {
      top:[],
      openArr:[],
      cindex:-1
      
    }
   },
   beforeMount(){
     this.openArr.length = this.citiesObjArray.length;
      for(let i=0,len = this.openArr.length;i<len;i++){
        this.openArr[i] = false;
      }
   },
   mounted(){

   	 this.getDomTop();
   },
  props:{
  	citiesletterArray:Array,
  	citiesObjArray:Array,
  	index:{
  	   default: 0,
	   type:Number
  	},
  	loadCity:{
  		default: ()=>{},
        type:Function
    },
  	mode:{
  		default: '',
    },
    callbackData:{
      default: ()=>{},
      type:Function
    },
    getlistCity:{
    	default: ()=>{},
        type:Function
    },
    tabindex:{
       default: 0,
       type:Number
    },
    clickFn:{
      default: ()=>{},
        type:Function
    }
  },
  watch:{
    tabindex(){
     
    }
  },

  updated(){

  },
  methods:{
     callbackAction(data){
       this.clickFn(data)
     },
     requireaction (i, o){
         if(!this.citiesObjArray[i][0]){
        let country = this.index=='0'? 'gn':''
        this.loadCity(this.buildrequirecity, o, country, i);
      }else{
    
        if(i==this.cindex){
            if(!!this.openArr[i]){
              //此时展开再次点击，关闭
              this.openArr[i] = false;
            }else{
              //此时关闭，点击 展开

              this.openArr[i] = true;
            }
            this.cindex = i;
           
        }else{
          this.openArr[i] = false;
           this.cindex = i;
        }
        
      }
     },
       buildrequirecity(arr, o, index) {
 
        let citiesObjArray = this.citiesObjArray;
        for(let i=0,len = citiesObjArray.length; i<len; i++){
          if(this.citiesletterArray[i]==o){
            citiesObjArray[i] = arr;
          }
        }
        this.cindex =index;
        this.citiesObjArray = citiesObjArray;

      },
     getDomTop (){
          console.log(this.tabindex)
            var _refs = 'citiesWrap_'+this.index;

            let node = this.$refs[_refs];
            global_.top[this.index] = [];
           
            for(let i=0,len = node.children.length;i<len;i++){
            let _top = node.children[i].offsetTop;
              global_.top[this.index].push(_top);
            }

       console.log(global_.top)
            this.callbackData(global_.top)
     },
  }
}
</script>