import bridge from './bridge.js'
const dfn = '_tc_ntv_web';
const pageCache = 'open_new_url_data_callback';

var web = {
    openNewUrl (param){
        return new Promise(function(resolve, reject) {
            function callback (cdata){
                resolve(cdata)
            }
            bridge.sendAction({
                param:{
                    ...param
                    
                },
                cbcache:pageCache,
                version:720,
                callback:callback
            },dfn,'open_newurl');
                //reject(error);
        });
    },
    dataCallback (param){
        bridge.sendAction({
            param:{
                ...param
            },
            cbcache:pageCache,
            version:720
        },dfn,'data_callback');
    }
}

let config = {
    clearCache:{
        n:'clear_cache',v:731
    },
    setWebviewMark:{
        n:'set_webview_mark',v:806,cbcache:bridge.cacheName(dfn,'set_webview_mark')
    },
    jumpWebviewMark:{
        n:'jump_webview_mark',v:806,cbcache:bridge.cacheName(dfn,'jump_webview_mark')
    },
    playAudio:{
        n:'play_audio',v:811,av:-1,cbcache:bridge.cacheName(dfn,'play_audio')
    },
    sendError:{
        n:'send_error_info',v:830
    },
    readHybridDirectory:{
        n:'read_hybrid_directory_info',v:830
    },
    openWithClose:{
        n:'open_with_close',
        v:820,
        notSupport:function(json){
            if (json && json.param) {
                var jumpUrl = json.param.jumpUrl;
                if (jumpUrl){
                    if (/^(?:tctclient|(?:http|tctravel):\/\/shouji.17u.cn\/internal)/.test(jumpUrl) || jumpUrl.indexOf('tcwvcnew') > 0) {
                        location.href = jumpUrl;
                    } else {
                        web.openNewUrl(json.param);
                    }
                    bridge.closeCache = function(data){ // 在失活情况下关闭当前页面
                        if (data && data.isStop === "false"){
                            bridge.closeCache = null;
                            setTimeout(function(){
                                location.href = "tctravel://shouji.17u.cn/internal/common/close"
                            }, 0);
                        }
                    }
                }
            }
        }
    },
}

bridge.registerFn(web,config,dfn)
export default web;